<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NetSuite + React Multi-Step Form</title>
    <script>
      window.suiteletDataUrl = "http://localhost:3001/userData"; // Update if needed
      window.submitUrl = "https://YOUR_SUITELET_URL_HERE"; // Replace with actual Suitelet POST endpoint
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="root" class="w-full px-4 py-10"></div>
    <script type="text/babel">
      async function fetchJsonWithGuard(
        url,
        { timeoutMs = 8000, ...init } = {}
      ) {
        if (!url || typeof url !== "string") {
          throw new Error("Missing or invalid suiteletDataUrl");
        }

        // timeout via AbortController
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), timeoutMs);

        let res, text;
        try {
          res = await fetch(url, {
            credentials: "same-origin",
            signal: controller.signal,
            ...init,
          });
          text = await res.text(); // read once; we’ll decide how to parse
        } catch (e) {
          clearTimeout(t);
          throw new Error(`Network/timeout error: ${e.message}`);
        }
        clearTimeout(t);

        if (!res.ok) {
          // show a small slice of body to help debug
          throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);
        }

        const contentType = (
          res.headers.get("content-type") || ""
        ).toLowerCase();
        if (contentType.includes("application/json")) {
          try {
            return JSON.parse(text);
          } catch (e) {
            throw new Error(`Invalid JSON from server: ${e.message}`);
          }
        }

        // If not JSON, likely HTML (login/notice/error)
        // Try a last-chance parse; if it fails, surface a helpful error.
        try {
          return JSON.parse(text);
        } catch {
          throw new Error(
            `Non-JSON response (likely HTML). First 200 chars:\n${text.slice(
              0,
              200
            )}`
          );
        }
      }

      function Field({
        label,
        name,
        type = "text",
        value = "",
        onChange,
        disabled = false,
        options = [],
        placeholder = "",
        rows = 4,
      }) {
        const sharedProps = {
          name,
          id: name,
          value: value ?? "",
          onChange,
          disabled,
          className:
            "w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary disabled:bg-gray-100",
        };

        return (
          <div className="w-full">
            <label
              htmlFor={name}
              className="block text-sm font-medium text-gray-600 mb-1"
            >
              {label}
            </label>
            {type === "textarea" ? (
              <textarea
                {...sharedProps}
                rows={rows}
                placeholder={placeholder}
              />
            ) : type === "select" ? (
              <select {...sharedProps}>
                <option value="" disabled>
                  {placeholder || "-- Select an option --"}
                </option>
                {options.map((opt, i) => (
                  <option key={i} value={opt.value}>
                    {opt.label}
                  </option>
                ))}
              </select>
            ) : (
              <input type={type} {...sharedProps} placeholder={placeholder} />
            )}
          </div>
        );
      }

      function FormWrapper({
        title,
        children,
        onContinue,
        onBack,
        showBack,
        step,
        totalSteps,
        isSubmitting,
        hideStepCount = false,
      }) {
        const isFinalStep = step === totalSteps - 1;
        return (
          <div className="bg-white p-6 rounded-2xl shadow w-[720px] space-y-4">
            <h2 className="text-xl font-semibold text-gray-800 text-center mb-2">
              {title}
            </h2>
            {!hideStepCount && (
              <div className="text-sm text-center text-gray-500 mb-4">
                Step {step + 1} of {totalSteps}
              </div>
            )}
            <div className="space-y-4">{children}</div>
            <div className="flex justify-between pt-4">
              {showBack ? (
                <button
                  onClick={onBack}
                  className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition flex items-center"
                >
                  <span className="mr-2">←</span> Back
                </button>
              ) : (
                <div></div>
              )}
              <button
                onClick={onContinue}
                disabled={isSubmitting}
                className="bg-primary text-white px-6 py-2 rounded-lg hover:bg-indigo-600 transition flex items-center justify-center min-w-[120px]"
              >
                {isSubmitting ? (
                  <span className="animate-spin border-2 border-white border-t-transparent rounded-full h-5 w-5"></span>
                ) : isFinalStep ? (
                  "Submit"
                ) : (
                  "Continue"
                )}
              </button>
            </div>
          </div>
        );
      }

      function BankAccountForm({
        initialValues,
        onContinue,
        step,
        totalSteps,
      }) {
        const [formData, setFormData] = React.useState(initialValues || {});
        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData((prev) => ({ ...prev, [name]: value }));
        };

        return (
          <FormWrapper
            title="BANK ACCOUNT INFORMATION"
            onContinue={() => onContinue(formData)}
            step={step}
            totalSteps={totalSteps}
          >
            <Field
              label="Email Address"
              name="email"
              value={formData.email}
              onChange={handleChange}
              disabled
            />
            <Field
              label="Payment Method"
              name="paymentMethod"
              value={formData.paymentMethod}
              onChange={handleChange}
              disabled
            />
            <Field
              label="Receiving Bank Primary ID"
              name="primaryId"
              value={formData.primaryId}
              onChange={handleChange}
            />
            <Field
              label="Receiving Party Account"
              name="receivingAccount"
              value={formData.receivingAccount}
              onChange={handleChange}
            />
            <Field
              label="Secondary Bank Routing Number"
              name="secondaryRouting"
              value={formData.secondaryRouting}
              onChange={handleChange}
            />
            <Field
              label="Secondary Bank Account"
              name="secondaryAccount"
              value={formData.secondaryAccount}
              onChange={handleChange}
            />
            <Field
              label="Payment Purpose"
              name="paymentPurpose"
              value={formData.paymentPurpose}
              onChange={handleChange}
            />
          </FormWrapper>
        );
      }

      function AddDocumentsForm({
        initialValues,
        onContinue,
        onBack,
        step,
        totalSteps,
      }) {
        return (
          <FormWrapper
            title="ADD DOCUMENTS"
            onContinue={() => onContinue(initialValues)}
            onBack={onBack}
            showBack
            step={step}
            totalSteps={totalSteps}
          >
            <button className="w-full py-2 px-4 rounded bg-indigo-500 text-white">
              Upload W9
            </button>
            <button className="w-full py-2 px-4 rounded bg-indigo-500 text-white">
              Upload Check
            </button>
            <button className="w-full py-2 px-4 rounded bg-indigo-500 text-white">
              Upload Doc1
            </button>
            <button className="w-full py-2 px-4 rounded bg-indigo-500 text-white">
              Upload Doc2
            </button>
          </FormWrapper>
        );
      }

      function BillingAddressForm({
        initialValues,
        onContinue,
        onBack,
        step,
        totalSteps,
      }) {
        const [formData, setFormData] = React.useState(initialValues || {});
        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData((prev) => ({ ...prev, [name]: value }));
        };

        return (
          <FormWrapper
            title="BILLING ADDRESS"
            onContinue={() => onContinue(formData)}
            onBack={onBack}
            showBack
            step={step}
            totalSteps={totalSteps}
          >
            <Field
              label="Vendor Name"
              name="vendorName"
              value={formData.vendorName}
              onChange={handleChange}
              disabled
            />
            <Field
              label="Phone Number"
              name="phone"
              value={formData.phone}
              onChange={handleChange}
            />
            <Field
              label="Address Line 1"
              name="address1"
              value={formData.address1}
              onChange={handleChange}
            />
            <Field
              label="Address Line 2"
              name="address2"
              value={formData.address2}
              onChange={handleChange}
            />
            <Field
              label="City"
              name="city"
              value={formData.city}
              onChange={handleChange}
            />
            <Field
              label="ZIP CODE"
              name="zip"
              value={formData.zip}
              onChange={handleChange}
            />
            <Field
              label="State/Province"
              name="state"
              value={formData.state}
              onChange={handleChange}
            />
            <Field
              label="Country"
              name="country"
              value={formData.country}
              onChange={handleChange}
            />
          </FormWrapper>
        );
      }

      function BankAddressForm({
        initialValues,
        onContinue,
        onBack,
        step,
        totalSteps,
      }) {
        const [formData, setFormData] = React.useState(initialValues || {});
        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData((prev) => ({ ...prev, [name]: value }));
        };

        return (
          <FormWrapper
            title="BANK ADDRESS"
            onContinue={() => onContinue(formData)}
            onBack={onBack}
            showBack
            step={step}
            totalSteps={totalSteps}
          >
            <Field
              label="Bank Name"
              name="bankName"
              value={formData.bankName}
              onChange={handleChange}
            />
            <Field
              label="Address Line 1"
              name="address1"
              value={formData.address1}
              onChange={handleChange}
            />
            <Field
              label="City"
              name="city"
              value={formData.city}
              onChange={handleChange}
            />
            <Field
              label="State/Province"
              name="state"
              value={formData.state}
              onChange={handleChange}
            />
            <Field
              label="Country"
              name="country"
              value={formData.country}
              onChange={handleChange}
            />
            <Field
              label="ZIP CODE"
              name="zip"
              value={formData.zip}
              onChange={handleChange}
            />
          </FormWrapper>
        );
      }

      function App() {
        const [step, setStep] = React.useState(0);
        const [formValues, setFormValues] = React.useState({});
        const [userData, setUserData] = React.useState(null);
        const [submitted, setSubmitted] = React.useState(false);
        const [isSubmitting, setIsSubmitting] = React.useState(false);
        const [errorMsg, setErrorMsg] = React.useState(null);

        React.useEffect(() => {
          (async () => {
            try {
              const url = window.suiteletDataUrl; // defined in a <script> tag above
              const data = await fetchJsonWithGuard(url);

              setUserData(data);
              setFormValues({
                bankAccount: {
                  email: data.email || "",
                  paymentMethod: data.paymentMethod || "",
                  primaryId: data.primaryId || "",
                  receivingAccount: data.receivingAccount || "",
                  secondaryRouting: data.secondaryRouting || "",
                  secondaryAccount: data.secondaryAccount || "",
                  paymentPurpose: data.paymentPurpose || "",
                },
                documents: {
                  w9: data.w9 || "",
                  check: data.check || "",
                  doc1: data.doc1 || "",
                  doc2: data.doc2 || "",
                },
                billingAddress: {
                  vendorName: data.vendorName || "",
                  phone: data.phone || "",
                  address1: data.address1 || "",
                  address2: data.address2 || "",
                  city: data.city || "",
                  zip: data.zip || "",
                  state: data.state || "",
                  country: data.country || "",
                },
                bankAddress: {
                  bankName: data.bankName || "",
                  address1: data.bankAddress1 || "",
                  city: data.bankCity || "",
                  state: data.bankState || "",
                  country: data.bankCountry || "",
                  zip: data.bankZip || "",
                },
              });
            } catch (err) {
              console.error("Error fetching Suitelet data:", err);
              setErrorMsg(err.message);

              // Optional fallback to local mock if available:
              // try {
              //   const data = await fetchJsonWithGuard("http://localhost:3001/userData", { timeoutMs: 3000 });
              //   setUserData(data);
              //   // ... setFormValues exactly as above
              //   setErrorMsg(null);
              // } catch (fallbackErr) {
              //   console.error("Fallback fetch failed:", fallbackErr);
              // }
            }
          })();
        }, []);

        const handleBack = () => setStep((prev) => Math.max(prev - 1, 0));
        const handleContinue = (section, values) => {
          setFormValues((prev) => ({ ...prev, [section]: values }));
          setStep((prev) => prev + 1);
        };

        const handleSubmit = () => {
          setIsSubmitting(true);

          //  Commented out real submission for testing
          // fetch(window.submitUrl, {
          //   method: "POST",
          //   headers: { "Content-Type": "application/json" },
          //   body: JSON.stringify(formValues)
          // })
          //   .then(res => res.ok ? res.json() : Promise.reject("Submission failed"))
          //   .then(() => {
          //     setSubmitted(true);
          //     setIsSubmitting(false);
          //   })
          //   .catch(err => {
          //     console.error("Error submitting:", err);
          //     alert("Something went wrong.");
          //     setIsSubmitting(false);
          //   });

          setTimeout(() => {
            setSubmitted(true);
            setStep(0); // reset back to beginning
            setIsSubmitting(false);
          }, 500);
        };

        const totalSteps = 4;

        const renderStep = () => {
          if (!userData) return <p>Loading user data...</p>;
          if (submitted) {
            return (
              <div className="bg-white p-6 rounded-2xl shadow w-[720px]">
                <pre className="text-sm bg-gray-100 p-4 rounded whitespace-pre-wrap">
                  {JSON.stringify(formValues, null, 2)}
                </pre>
              </div>
            );
          }

          switch (step) {
            case 0:
              return (
                <BankAccountForm
                  initialValues={formValues.bankAccount}
                  onContinue={(data) => handleContinue("bankAccount", data)}
                  step={step}
                  totalSteps={totalSteps}
                />
              );
            case 1:
              return (
                <AddDocumentsForm
                  initialValues={formValues.documents}
                  onContinue={(data) => handleContinue("documents", data)}
                  onBack={handleBack}
                  step={step}
                  totalSteps={totalSteps}
                />
              );
            case 2:
              return (
                <BillingAddressForm
                  initialValues={formValues.billingAddress}
                  onContinue={(data) => handleContinue("billingAddress", data)}
                  onBack={handleBack}
                  step={step}
                  totalSteps={totalSteps}
                />
              );
            case 3:
              return (
                <BankAddressForm
                  initialValues={formValues.bankAddress}
                  onContinue={(data) => handleContinue("bankAddress", data)}
                  onBack={handleBack}
                  step={step}
                  totalSteps={totalSteps}
                />
              );
            default:
              return (
                <FormWrapper
                  title="REVIEW & SUBMIT"
                  onContinue={handleSubmit}
                  onBack={handleBack}
                  showBack
                  step={step}
                  totalSteps={totalSteps}
                  isSubmitting={isSubmitting}
                  hideStepCount={true}
                >
                  <pre className="text-sm bg-gray-100 p-4 rounded whitespace-pre-wrap">
                    {JSON.stringify(formValues, null, 2)}
                  </pre>
                </FormWrapper>
              );
          }
        };

        return (
          <div className="w-full max-w-3xl mx-auto">
            <div className="mb-6 text-center">
              <h1 className="text-2xl font-bold text-gray-800">
                {submitted
                  ? "Thank you for completing the form"
                  : `Welcome ${
                      userData?.name || "User"
                    }, please enter your details`}
              </h1>
              {errorMsg && (
                <p className="mt-2 text-sm text-red-600 whitespace-pre-wrap">
                  {`Data fetch issue: ${errorMsg}\n• If this is a login or HTML response, make sure your Suitelet returns JSON and the deployment/permissions are correct.`}
                </p>
              )}
            </div>

            {/* Later, before rendering steps: */}
            {!userData && !errorMsg && <p>Loading user data...</p>}
            {errorMsg && !userData && (
              <div className="bg-white p-4 rounded shadow text-sm text-gray-700">
                <p className="mb-2 font-medium">We couldn’t load your data.</p>
                <ul className="list-disc ml-5 space-y-1">
                  <li>Confirm the Suitelet URL and deployment status.</li>
                  <li>
                    Ensure the endpoint returns <code>application/json</code>{" "}
                    (not HTML).
                  </li>
                  <li>
                    If anonymous, set “Available without Login” and use external
                    URL.
                  </li>
                  <li>
                    If authenticated, use internal URL while logged in (same
                    domain).
                  </li>
                </ul>
              </div>
            )}

            <div className="flex items-center justify-center">
              {renderStep()}
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
